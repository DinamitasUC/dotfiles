var connections={};chrome.runtime.onConnect.addListener(function(e){if("ScopusDDMExtension"!=e.name)return;const s=e.sender.tab?e.sender.tab.id:void 0,t=function(t){if("response-to-cs"!==t.type)if("init-from-cs"!=t.type){if("request-from-cs"===t.type&&(t.tabId=t.tabId||s,DDMMessageHandler.handleRequestMessage(t)),"fetch-data"===t.type){const e=t.data;HttpClient._http_retry(e,e.retryCount,1,e.timeout,(n=t,e=>{DDMMessageHandler._processResponseMessage(n,e)}),function(e){return s=>{DDMMessageHandler._processResponseMessage(e,s)}}(t))}var n;"download-file"===t.type&&chrome.downloads.download({url:t.data.url,filename:t.data.filename||null},function(e){chrome.downloads.search({id:e},s=>{var n=s?s[0]:void 0;n?"interrupted"===n.state?DDMMessageHandler._processResponseMessage(t,{downloadId:e}):DDMMessageHandler._processResponseMessage(t,{downloadId:e,downloadItem:n}):DDMMessageHandler._processResponseMessage(e,t)})})}else{connections[s]=e;var o=chrome.runtime.getManifest();e.postMessage({type:"init-response-to-cs",tabId:s,extensionVersion:o.version,extensionName:o.name})}};e.onMessage.addListener(t),e.onDisconnect.addListener(function(e){e.onMessage.removeListener(t),delete connections[s]})});class DDMMessageHandler{static handleRequestMessage(e){}static _processResponseMessage(e,s){var t=connections[e.tabId];if(!t)throw Error("Unable to find port for responding message to tab!");t.postMessage({type:"response-to-cs",data:s,request:e})}}class HttpClient{static _http_retry(e,s,t,n,o,a){let r;fetch(e.url,{method:e.method,headers:e.headers||{}}).then(e=>(r=e).text()).then(d=>{var i={status:r.status,statusText:r.statusText,content:d,contentType:r.headers.get("Content-Type"),headers:r.headers,triedCount:t,responseURL:r.url};if(200!==r.status)return 1===s?void a(i):HttpClient._http_retry(e,s-1,t+1,n,o,a);o(i)}).catch(e=>{console.error(e)})}}