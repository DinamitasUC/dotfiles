let port,currentTabId,extensionVersion,extensionName;const fetchRequestsQueue=new Map;class DDMEventHandler{static setupPort(){port||((port=chrome.runtime.connect(null,{name:"ScopusDDMExtension"})).postMessage({type:"init-from-cs"}),port.onDisconnect.addListener(function(){port=null}),port.onMessage.addListener(DDMEventHandler.handleMessage))}static handleMessage(e){"init-response-to-cs"===e.type?(currentTabId=e.tabId,extensionName=e.extensionName,extensionVersion=e.extensionVersion):"response-to-cs"===e.type&&(e.extensionVersion=extensionVersion,fetchRequestsQueue.has(e.request.data.url)&&fetchRequestsQueue.get(e.request.data.url)(e.data))}static handleRequest(e){DDMEventHandler.setupPort(),"TestCommunication"===e.detail.action?DDMEventHandler.testCommunication(e):DDMEventHandler.locatePDF(e.detail)}static locatePDF(e){const t={data:e,httpMessenger:(e,t)=>{fetchRequestsQueue.set(e.url,t),e.filename?DDMEventHandler.postMessage({type:"download-file",tabId:currentTabId,extensionName:extensionName,data:e}):DDMEventHandler.postMessage({type:"fetch-data",tabId:currentTabId,extensionName:extensionName,data:e})}};PDFLocator.locatePDF(t,function(e){DDMEventHandler._responseEvent({data:e})})}static postMessage(e){port.postMessage(e)}static testCommunication(e){var t=document.createElement("div");t.id="DDMExtension-testelementid",t.style.visibility="hidden",t.setAttribute("class","DDMExtension-testelement"),t.setAttribute("data-extension-loaded","true");try{DDMEventHandler.postMessage({type:"test-from-cs"}),t.setAttribute("data-extension-enabled","true"),t.setAttribute("data-extension-version",extensionVersion)}catch(e){console.error(e),t.setAttribute("data-extension-enabled","false")}document.body.appendChild(t)}static _responseEvent(e){var t=new CustomEvent("DDMResponseEvent",{detail:JSON.stringify(DDMEventHandler._removeExtensionAttributes(e))});document.dispatchEvent(t)}static _removeExtensionAttributes(e){return delete e.type,e}}document.addEventListener("DDMRequestEvent",DDMEventHandler.handleRequest),document.addEventListener("DOMContentLoaded",DDMEventHandler.setupPort);